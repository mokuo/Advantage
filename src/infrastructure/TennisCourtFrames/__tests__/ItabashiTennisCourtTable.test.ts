import MockDate from "mockdate"; // eslint-disable-line node/no-unpublished-import
import ItabashiTennisCourtTable from "../ItabashiTennisCourtTable";
import FacilityName from "#src/domain/models/Organizations/FacilityName";
import OrganizationName from "#src/domain/models/Organizations/OrganizationName";
import TennisCourtFrame from "#src/domain/models/TennisCourtFrames/TennisCourtFrame";
import TennisCourtFrameId from "#src/domain/models/TennisCourtFrames/TennisCourtFrameId";
import TennisCourtFrameStatus from "#src/domain/models/TennisCourtFrames/TennisCourtFrameStatus";
import TennisCourtName from "#src/domain/models/TennisCourtFrames/TennisCourtName";
import UsageTime from "#src/domain/models/TennisCourtFrames/UsageTime";
import OrganizationRepository from "#src/infrastructure/Organizations/OrganizationRepository";

describe("ItabashiTennisCourtName", () => {
  describe("#extractTennisCourt", () => {
    // HACK: 移行期間？なのか、15:00~16:00 が2行ある
    it.skip("テーブルの配列から TennisCourt を全て抽出する", async () => {
      MockDate.set(new Date(2022, 4 - 1, 20));
      const orgRepo = new OrganizationRepository();
      const org = await orgRepo.findByName(new OrganizationName("板橋区"));
      const facility = org?.findFacilityByName(new FacilityName("東板橋庭球場"));
      if (facility === undefined) {
        throw new Error("Facility が undefined です");
      }

      // NOTE: src/lib/__tests__/parseHtmlTable.test.ts を使って parseHtmlTable の戻り値を確認
      const table = [
        [
          "● 土日祝の第３面はソフトテニス優先面（硬式抽選申込不可）となります。",
          "● 土日祝の第３面はソフトテニス優先面（硬式抽選申込不可）となります。",
          "● 土日祝の第３面はソフトテニス優先面（硬式抽選申込不可）となります。",
          "● 土日祝の第３面はソフトテニス優先面（硬式抽選申込不可）となります。",
          "● 土日祝の第３面はソフトテニス優先面（硬式抽選申込不可）となります。",
          "● 土日祝の第３面はソフトテニス優先面（硬式抽選申込不可）となります。",
          "● 土日祝の第３面はソフトテニス優先面（硬式抽選申込不可）となります。",
          "● 土日祝の第３面はソフトテニス優先面（硬式抽選申込不可）となります。",
          "● 土日祝の第３面はソフトテニス優先面（硬式抽選申込不可）となります。",
        ],
        [
          "前の31日分ボタン",
          "前の31日分ボタン",
          "4月20日",
          "4月21日",
          "4月22日",
          "4月23日",
          "4月24日",
          "4月25日",
          "4月26日",
          "4月27日",
          "4月28日",
          "4月29日",
          "4月30日",
          "5月1日",
          "5月2日",
          "5月3日",
          "5月4日",
          "5月5日",
          "5月6日",
          "5月7日",
          "5月8日",
          "5月9日",
          "5月10日",
          "5月11日",
          "5月12日",
          "5月13日",
          "5月14日",
          "5月15日",
          "5月16日",
          "5月17日",
          "5月18日",
          "5月19日",
          "5月20日",
        ],
        ["東板橋庭球場（軟式優先）３面"],
        [
          "東板橋庭球場（軟式優先）３面",
          "09:00 ～11:00",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "空いています",
          "空いています",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
        ],
        [
          "東板橋庭球場（軟式優先）３面",
          "11:00 ～13:00",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "空いています",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
        ],
        [
          "東板橋庭球場（軟式優先）３面",
          "13:00 ～15:00",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
        ],
        [
          "東板橋庭球場（軟式優先）３面",
          "15:00 ～17:00",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "空いています",
          "予約済みです",
          "予約済みです",
          "空いています",
          "予約済みです",
        ],
        [
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
        ],
        [""],
        [
          "● 土日祝の第３面はソフトテニス優先面（硬式抽選申込不可）となります。",
          "● 土日祝の第３面はソフトテニス優先面（硬式抽選申込不可）となります。",
          "● 土日祝の第３面はソフトテニス優先面（硬式抽選申込不可）となります。",
          "● 土日祝の第３面はソフトテニス優先面（硬式抽選申込不可）となります。",
          "● 土日祝の第３面はソフトテニス優先面（硬式抽選申込不可）となります。",
          "● 土日祝の第３面はソフトテニス優先面（硬式抽選申込不可）となります。",
          "● 土日祝の第３面はソフトテニス優先面（硬式抽選申込不可）となります。",
          "● 土日祝の第３面はソフトテニス優先面（硬式抽選申込不可）となります。",
          "● 土日祝の第３面はソフトテニス優先面（硬式抽選申込不可）となります。",
        ],
        [
          "前の31日分ボタン",
          "前の31日分ボタン",
          "4月20日",
          "4月21日",
          "4月22日",
          "4月23日",
          "4月24日",
          "4月25日",
          "4月26日",
          "4月27日",
          "4月28日",
          "4月29日",
          "4月30日",
          "5月1日",
          "5月2日",
          "5月3日",
          "5月4日",
          "5月5日",
          "5月6日",
          "5月7日",
          "5月8日",
          "5月9日",
          "5月10日",
          "5月11日",
          "5月12日",
          "5月13日",
          "5月14日",
          "5月15日",
          "5月16日",
          "5月17日",
          "5月18日",
          "5月19日",
          "5月20日",
        ],
        ["東板橋庭球場（硬軟兼用）４面"],
        [
          "東板橋庭球場（硬軟兼用）４面",
          "09:00 ～11:00",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "空いています",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "空いています",
          "予約済みです",
          "予約済みです",
          "予約済みです",
        ],
        [
          "東板橋庭球場（硬軟兼用）４面",
          "11:00 ～13:00",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "空いています",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "空いています",
          "予約済みです",
          "予約済みです",
          "予約済みです",
        ],
        [
          "東板橋庭球場（硬軟兼用）４面",
          "13:00 ～15:00",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
        ],
        [
          "東板橋庭球場（硬軟兼用）４面",
          "15:00 ～17:00",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
          "予約済みです",
        ],
        [
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
          "ページの先頭へボタン",
        ],
      ];
      const expectedFirstTennisCourt = new TennisCourtFrame(
        TennisCourtFrameId.build(),
        facility.id,
        new TennisCourtName("東板橋庭球場（軟式優先）３面"),
        new UsageTime(new Date(2022, 4 - 1, 20, 9, 0), new Date(2022, 4 - 1, 20, 11, 0)),
        new TennisCourtFrameStatus("unavailable")
      );
      const expectedLastTennisCourt = new TennisCourtFrame(
        TennisCourtFrameId.build(),
        facility.id,
        new TennisCourtName("東板橋庭球場（硬軟兼用）４面"),
        new UsageTime(new Date(2022, 5 - 1, 20, 15, 0), new Date(2022, 5 - 1, 20, 17, 0)),
        new TennisCourtFrameStatus("unavailable")
      );

      const tennisCourtFrames = await new ItabashiTennisCourtTable().extractTennisCourtFrames(table);

      expect(tennisCourtFrames.length).toEqual(248);
      expect(tennisCourtFrames[0].isSameFrame(expectedFirstTennisCourt)).toBeTruthy();
      expect(tennisCourtFrames[tennisCourtFrames.length - 1].isSameFrame(expectedLastTennisCourt)).toBeTruthy();
    });
  });

  describe("#getYearByMonth", () => {
    it.each([
      { today: new Date(2021, 12 - 1, 30), month: 12, expected: 2021 },
      { today: new Date(2021, 12 - 1, 30), month: 1, expected: 2022 },
    ])("month が今年より前の場合は来年、それ以外は今年と判断する", ({ today, month, expected }) => {
      MockDate.set(today);
      const itabashiTennisCourtTable = new ItabashiTennisCourtTable();
      // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access, @typescript-eslint/no-unsafe-call
      expect((itabashiTennisCourtTable as any).getYearByMonth(month)).toEqual(expected);
    });
  });
});
